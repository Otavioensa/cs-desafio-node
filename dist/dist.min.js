var express=require("express"),app=express(),routes=require("./route"),bodyParser=require("body-parser"),validator=require("express-validator"),bearerToken=require("express-bearer-token"),validation=require("./validation");app.use(bodyParser.urlencoded({extended:!0})),app.use(bodyParser.json()),app.use(bearerToken()),app.use(validator()),app.post("/usuario",validation.cadastrarUsuario),app.get("/usuario/:id",validation.retornarUsuario),app.put("/signIn",validation.signIn),app.use("/",routes),app.use(function(e,o){o.status(404).json({mensagem:"Recurso não existente"})}),app.listen(process.env.PORT||3e3,function(){console.log("Server no ar")});var gulp=require("gulp"),jshint=require("gulp-jshint"),uglify=require("gulp-uglify"),concat=require("gulp-concat"),rename=require("gulp-rename"),files=["./*.js","controller/*.js","db/*.js","model/*.js","route/*.js","validation/*.js"];gulp.task("lint",function(){gulp.src(files).pipe(jshint()).pipe(jshint.reporter("default"))}),gulp.task("dist",function(){gulp.src(files).pipe(concat("./dist")).pipe(rename("dist.min.js")).pipe(uglify()).pipe(gulp.dest("./dist"))}),gulp.task("default",function(){gulp.run("lint","dist"),gulp.watch(files,function(){gulp.run("lint","dist")})});var async=require("async"),guid=require("guid"),moment=require("moment"),jwt=require("jsonwebtoken"),model=require("../model"),controller={};controller.cadastrarUsuario=function(e,o){var r=jwt.sign({foo:"bar"},"shhhhh"),n={_id:String(guid.create()),nome:e.body.nome,email:e.body.email,senha:e.body.senha,token:r,telefones:e.body.telefones};model.cadastrarUsuario(n,function(e,r){if(e)o.status(422).json({mensagem:"E-mail já existente."});else{var n={usuario:r,data_criacao:moment().format("YYYY-MM-DD"),data_atualizacao:moment().format("YYYY-MM-DD"),ultimo_login:moment().format("YYYY-MM-DD")};o.json(n)}})},controller.retornarUsuario=function(e,o){try{jwt.verify(e.token,"shhhhh")}catch(r){return"TokenExpiredError"===r.name?o.status(401).json({mensagem:"Sessão inválida"}):o.status(401).json({mensagem:"Não autorizado"})}var n={_id:e.params.id};model.retornarUsuario(n,function(r,n){r?o.status(422).json({mensagem:"Problema ao inserir no banco de dados"}):n[0].token!==e.token?o.status(401).json({mensagem:"Não autorizado"}):o.json(n)})},controller.signIn=function(e,o){var r=jwt.sign({foo:"bar"},"shhhhh",{expiresInSeconds:1800}),n={query:{$and:[{email:e.body.email},{senha:e.body.senha}]},update:{$set:{ultimo_login:moment().format("YYYY-MM-DD"),data_atualizacao:moment().format("YYYY-MM-DD"),token:r}},"new":!0};model.signIn(n,function(e,r,n){e?o.status(503).json({mensagem:"Erro ao fazer login."}):n.n<1?o.status(422).json({mensagem:"Usuário e/ou senha inválidos"}):o.json({sigIn:!0})})},module.exports=controller;var mongojs=require("mongojs"),db=mongojs("concrete_solutions");module.exports=db;var db=require("../db"),model={};model.cadastrarUsuario=function(e,o){db.collection("concrete_solutions_document").insert(e,o)},model.retornarUsuario=function(e,o){db.collection("concrete_solutions_document").find(e,o)},model.signIn=function(e,o){db.collection("concrete_solutions_document").findAndModify(e,o)},module.exports=model;var router=require("express").Router(),controller=require("../controller");router.post("/usuario",controller.cadastrarUsuario),router.get("/usuario/:id",controller.retornarUsuario),router.put("/signIn",controller.signIn),module.exports=router;var validation={};validation.cadastrarUsuario=function(e,o,r){e.checkBody("email","Informe um email válido").notEmpty().isEmail(),e.checkBody("nome","Informe um nome").notEmpty(),e.checkBody("senha","Informe um senha").notEmpty(),e.checkBody("telefones[0].numero","Informe pelo menos um número de telefone").notEmpty(),e.checkBody("telefones[0].ddd","Informe pelo menos um ddd de telefone").notEmpty();var n=e.validationErrors();return n?void o.status(400).json({mensagem:n[0].msg}):void r()},validation.retornarUsuario=function(e,o,r){e.checkParams("id","Informe um id").notEmpty(),e.checkParams("id","Informe um id com 36 caracteres").isLength(36);var n=e.validationErrors();return n?void o.status(400).json({mensagem:n[0].msg}):void r()},validation.signIn=function(e,o,r){e.checkBody("email","Informe um email válido").notEmpty().isEmail(),e.checkBody("senha","Informe um senha").notEmpty();var n=e.validationErrors();return n?void o.status(400).json({mensagem:n[0].msg}):void r()},module.exports=validation;